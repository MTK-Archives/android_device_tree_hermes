From 7693129f840aec4981f63706698df38eaf765682 Mon Sep 17 00:00:00 2001
From: Bilux <i.bilux@gmail.com>
Date: Sun, 15 Mar 2020 20:07:11 +0100
Subject: [PATCH] sensors: fix proximity sensor

Lower the requirement of proximity sensor API version to 1.1
---
 libs/sensor/Sensor.cpp | 8 +++++++
 1 file changed, 8 insertions(+)

diff --git a/libs/sensor/Sensor.cpp b/libs/sensor/Sensor.cpp
index a0e368c7e..e556b7d9f 100644
--- a/libs/sensor/Sensor.cpp
+++ b/libs/sensor/Sensor.cpp
@@ -52,6 +52,7 @@ Sensor::Sensor(struct sensor_t const& hwSensor, const uuid_t& uuid, int halVersi
     mMinDelay = hwSensor.minDelay;
     mFlags = 0;
     mUuid = uuid;
+    int mHalVersion = 0; // temporarily store overridden hal version
 
     // Set fifo event count zero for older devices which do not support batching. Fused
     // sensors also have their fifo counts set to zero.
@@ -146,6 +147,8 @@ Sensor::Sensor(struct sensor_t const& hwSensor, const uuid_t& uuid, int halVersi
     case SENSOR_TYPE_PROXIMITY:
         mStringType = SENSOR_STRING_TYPE_PROXIMITY;
         mFlags |= SENSOR_FLAG_ON_CHANGE_MODE;
+        mHalVersion = halVersion;
+        halVersion = SENSORS_DEVICE_API_VERSION_1_1;
         if (halVersion < SENSORS_DEVICE_API_VERSION_1_3) {
             mFlags |= SENSOR_FLAG_WAKE_UP;
         }
@@ -324,6 +327,11 @@ Sensor::Sensor(struct sensor_t const& hwSensor, const uuid_t& uuid, int halVersi
                     String16(mRequiredPermission));
         }
     }
+
+    if (mHalVersion > 0){
+        halVersion = mHalVersion;
+        mHalVersion = 0;
+    }
 }
 
 Sensor::~Sensor() {
